<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1 maximum-scale=1 minimum-scale=1 user-scalable=0" />
  <title>CGI for Caddy</title>
  <style>
    body {
      max-width: 800px;
      font-family: sans-serif;
      padding: 1em;
    }

    h1,
    h2,
    h3 {
      color: #345;
    }

    .syntax {
      display: block;
      white-space: pre;
      font-family: monospace;
      background-color: #efe;
      border: 1px solid #474;
      margin: 1em 0;
      padding: 0.25em 1.5em;
    }

    .warning {
      background-color: #ffd;
      border: 1px solid #665;
      margin: 1em 0;
      padding: 0 1em;
    }

    .key {
      color: #131;
      font-weight: bold;
    }

    .subkey {
      font-style: italic;
    }

    pre {
      margin: 1.5em 0;
      background-color: #eee;
      padding: 1em;
      overflow-x: scroll;
    }
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>

<body>
<h1 id="cgi-for-caddy">CGI for Caddy</h1>
<p><a href="https://raw.githubusercontent.com/jung-kurt/caddy-cgi/master/LICENSE"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="MIT licensed" /></a> <a href="https://goreportcard.com/report/github.com/jung-kurt/caddy-cgi"><img src="https://goreportcard.com/badge/github.com/jung-kurt/caddy-cgi" alt="Report" /></a></p>
<p>Package cgi implements the common gateway interface (<a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface">CGI</a>) for <a href="https://caddyserver.com/">Caddy</a>, a modern, full-featured, easy-to-use web server.</p>
<p>This plugin lets you generate dynamic content on your website by means of command line scripts. To collect information about the inbound HTTP request, your script examines certain environment variables such as <code>PATH_INFO</code> and <code>QUERY_STRING</code>. Then, to return a dynamically generated web page to the client, your script simply writes content to standard output. In the case of POST requests, your script reads additional inbound content from standard input.</p>
<p>The advantage of CGI is that you do not need to fuss with server startup and persistence, long term memory management, sockets, and crash recovery. Your script is called when a request matches one of the patterns that you specify in your Caddyfile. As soon as your script completes its response, it terminates. This simplicity makes CGI a perfect complement to the straightforward operation and configuration of Caddy. The benefits of Caddy, including HTTPS by default, basic access authentication, and lots of middleware options extend easily to your CGI scripts.</p>
<p>CGI has some disadvantages. For one, Caddy needs to start a new process for each request. This can adversely impact performance and, if resources are shared between CGI applications, may require the use of some interprocess synchronization mechanism such as a file lock. Your server’s responsiveness could in some circumstances be affected, such as when your web server is hit with very high demand, when your script’s dependencies require a long startup, or when concurrently running scripts take a long time to respond. However, in many cases, such as using a pre-compiled CGI application like fossil or a Lua script, the impact will generally be insignificant. Another restriction of CGI is that scripts will be run with the same permissions as Caddy itself. This can sometimes be less than ideal, for example when your script needs to read or write files associated with a different owner.</p>
<h3 id="security-considerations">Security Considerations</h3>
<p>Serving dynamic content exposes your server to more potential threats than serving static pages. There are a number of considerations of which you should be aware when using CGI applications.</p>
<p><strong>CGI scripts should be located outside of Caddy’s document root.</strong> Otherwise, an inadvertent misconfiguration could result in Caddy delivering the script as an ordinary static resource. At best, this could merely confuse the site visitor. At worst, it could expose sensitive internal information that should not leave the server.</p>
<p><strong>Mistrust the contents of <code>PATH_INFO</code>, <code>QUERY_STRING</code> and standard input.</strong> Most of the environment variables available to your CGI program are inherently safe because they originate with Caddy and cannot be modified by external users. This is not the case with <code>PATH_INFO</code>, <code>QUERY_STRING</code> and, in the case of POST actions, the contents of standard input. Be sure to validate and sanitize all inbound content. If you use a CGI library or framework to process your scripts, make sure you understand its limitations.</p>
<h3 id="errors">Errors</h3>
<p>An error in a CGI application is generally handled within the application itself and reported in the headers it returns. Additionally, if the Caddy <code>errors</code> directive is enabled, any content the application writes to its standard error stream will be written to the error log. This can be useful to diagnose problems with the execution of the CGI application.</p>
<h3 id="application-modes">Application Modes</h3>
<p>Your CGI application can be executed directly or indirectly. In the direct case, the application can be a compiled native executable or it can be a shell script that contains as its first line a shebang that identifies the interpreter to which the file’s name should be passed. Caddy must have permission to execute the application. On Posix systems this will mean making sure the application’s ownership and permission bits are set appropriately; on Windows, this may involve properly setting up the filename extension association.</p>
<p>In the indirect case, the name of the CGI script is passed to an interpreter such as lua, perl or python.</p>
<h3 id="basic-syntax">Basic Syntax</h3>
<p>The basic cgi directive lets you associate a single pattern with a particular script. The directive can be repeated any reasonable number of times. Here is the basic syntax:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">cgi</span> <span class="kw">match</span> <span class="kw">exec</span> [args...]</a></code></pre></div>
<p>For example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">cgi</span> /report /usr/local/<span class="kw">cgi</span>-bin/report</a></code></pre></div>
<p>When a request such as https://example.com/report or https://example.com/report/weekly arrives, the cgi middleware will detect the match and invoke the script named /usr/local/cgi-bin/report. The current working directory will be the same as Caddy itself. Here, it is assumed that the script is self-contained, for example a pre-compiled CGI application or a shell script. Here is an example of a standalone script, similar to one used in the cgi plugin’s test suite:</p>
<pre class="shell"><code>#!/bin/bash

printf &quot;Content-type: text/plain\n\n&quot;

printf &quot;PATH_INFO    [%s]\n&quot; $PATH_INFO
printf &quot;QUERY_STRING [%s]\n&quot; $QUERY_STRING

exit 0</code></pre>
<p>The environment variables <code>PATH_INFO</code> and <code>QUERY_STRING</code> are populated and passed to the script automatically. There are a number of other standard CGI variables included that are described below. If you need to pass any special environment variables or allow any environment variables that are part of Caddy’s process to pass to your script, you will need to use the advanced directive syntax described below.</p>
<p>The values used for the script name and its arguments are subject to placeholder replacement. In addition to the standard Caddy placeholders such as <code>{method}</code> and <code>{host}</code>, the following placeholder substitutions are made:</p>
<ul>
<li><span class="key">{.}</span> is replaced with Caddy’s current working directory</li>
<li><span class="key">{match}</span> is replaced with the portion of the request that satisfies the match directive</li>
<li><span class="key">{root}</span> is replaced with Caddy’s specified root directory</li>
</ul>
<p>You can include glob wildcards in your matches. Basically, an asterisk represents a sequence of zero or more non-slash characters and a question mark represents a single non-slash character. These wildcards can be used multiple times in a match expression. See the documentation for <a href="https://golang.org/pkg/path/#Match">path/Match</a> in the Go standard library for more details about glob matching. Here is an example directive:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">cgi</span> /report/*.lua /usr/bin/lua /usr/local/<span class="kw">cgi</span>-bin/{<span class="kw">match</span>}</a></code></pre></div>
<p>In this case, the cgi middleware will match requests such as https://example.com/report/weekly.lua and https://example.com/report/report.lua/weekly but not https://example.com/report.lua. The use of the asterisk expands to any character sequence within a directory. For example, if the request</p>
<pre><code>https://report/weekly.lua/summary</code></pre>
<p>is made, the following command is executed:</p>
<pre><code>/usr/bin/lua /usr/local/cgi-bin/report/weeky.lua</code></pre>
<p>Note that the portion of the request that follows the match is not included. That information is conveyed to the script by means of environment variables. In this example, the Lua interpreter is invoked directly from Caddy, so the Lua script does not need the shebang that would be needed in a standalone script. This method facilitates the use of CGI on the Windows platform.</p>
<h3 id="advanced-syntax">Advanced Syntax</h3>
<p>In order to specify custom environment variables, pass along one or more environment variables known to Caddy, or specify more than one match pattern for a given rule, you will need to use the advanced directive syntax. That looks like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">cgi</span> {</a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="kw">match</span> <span class="kw">match</span> [match2...]</a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="kw">except</span> <span class="kw">match</span> [match2...]</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="kw">exec</span> script [args...]</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="kw">dir</span> directory</a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="kw">env</span> key1=val1 [key2=val2...]</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="kw">pass_env</span> key1 [key2...]</a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="kw">empty_env</span> key1 [key2...]</a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="kw">pass_all_env</span></a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="kw">inspect</span></a>
<a class="sourceLine" id="cb7-11" title="11">}</a></code></pre></div>
<p>For example,</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">cgi</span> {</a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="kw">match</span> /sample/*.php /sample/app/*.php</a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">except</span> /sample/init.php</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="kw">exec</span> /usr/local/<span class="kw">cgi</span>-bin/phpwrap /usr/local/<span class="kw">cgi</span>-bin{<span class="kw">match</span>}</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">env</span> DB=/usr/local/share/app/app.db SECRET=/usr/local/share/app/secret</a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="kw">pass_env</span> HOME UID</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="kw">empty_env</span> CGI_LOCAL</a>
<a class="sourceLine" id="cb8-8" title="8">}</a></code></pre></div>
<p>With the advanced syntax, the <code>exec</code> subdirective must appear exactly once. The <code>match</code> subdirective must appear at least once. The <code>env</code>, <code>pass_env</code>, <code>empty_env</code>, and <code>except</code> subdirectives can appear any reasonable number of times. <code>pass_all_env</code>, <code>dir</code> may appear once.</p>
<p>The <code>dir</code> subdirective specifies the CGI executable’s working directory. If it is not specified, Caddy’s current working directory is used.</p>
<p>The <code>except</code> subdirective uses the same pattern matching logic that is used with the <code>match</code> subdirective except that the request must match a rule fully; no request path prefix matching is performed. Any request that matches a <code>match</code> pattern is then checked with the patterns in <code>except</code>, if any. If any matches are made with the <code>except</code> pattern, the request is rejected and passed along to subsequent handlers. This is a convenient way to have static file resources served properly rather than being confused as CGI applications.</p>
<p>The <code>empty_env</code> subdirective is used to pass one or more empty environment variables. Some CGI scripts may expect the server to pass certain empty variables rather than leaving them unset. This subdirective allows you to deal with those situations.</p>
<p>The values associated with environment variable keys are all subject to placeholder substitution, just as with the script name and arguments.</p>
<p>If your CGI application runs properly at the command line but fails to run from Caddy it is possible that certain environment variables may be missing. For example, the ruby gem loader evidently requires the <code>HOME</code> environment variable to be set; you can do this with the subdirective <code>pass_env HOME</code>. Another class of problematic applications require the <code>COMPUTERNAME</code> variable.</p>
<p>The <code>pass_all_env</code> subdirective instructs Caddy to pass each environment variable it knows about to the CGI excutable. This addresses a common frustration that is caused when an executable requires an environment variable and fails without a descriptive error message when the variable cannot be found. These applications often run fine from the command prompt but fail when invoked with CGI. The risk with this subdirective is that a lot of server information is shared with the CGI executable. Use this subdirective only with CGI applications that you trust not to leak this information.</p>
<h3 id="json-web-tokens">JSON web tokens</h3>
<p>If you protect your CGI application with the <a href="https://github.com/BTBurke/caddy-jwt">Caddy JWT</a> middleware, your program will have access to the token’s payload claims by means of environment variables. For example, the following token claims</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="dt">&quot;sub&quot;</span><span class="fu">:</span> <span class="st">&quot;1234567890&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="dt">&quot;user&quot;</span><span class="fu">:</span> <span class="st">&quot;quixote&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="dt">&quot;admin&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>will be available with the following environment variables</p>
<pre><code>HTTP_TOKEN_CLAIM_SUB=1234567890
HTTP_TOKEN_CLAIM_USER=quixote
HTTP_TOKEN_CLAIM_ADMIN=true</code></pre>
<p>All values are conveyed as strings, so some conversion may be necessary in your program. No placeholder substitutions are made on these values.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>If you run into unexpected results with the CGI plugin, you are able to examine the environment in which your CGI application runs. To enter inspection mode, add the subdirective <code>inspect</code> to your CGI configuration block. This is a development option that should not be used in production. When in inspection mode, the plugin will respond to matching requests with a page that displays variables of interest. In particular, it will show the replacement value of <code>{match}</code> and the environment variables to which your CGI application has access.</p>
<p>For example, consider this example CGI block:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">cgi</span> {</a>
<a class="sourceLine" id="cb11-2" title="2">    <span class="kw">match</span> /wapp/*</a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="kw">exec</span> /usr/local/bin/wapptclsh /home/quixote/projects{<span class="kw">match</span>}.tcl</a>
<a class="sourceLine" id="cb11-4" title="4">    <span class="kw">pass_env</span> HOME LANG</a>
<a class="sourceLine" id="cb11-5" title="5">    <span class="kw">env</span> DB=/usr/local/share/app/app.db SECRET=/usr/local/share/app/secret</a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="kw">inspect</span></a>
<a class="sourceLine" id="cb11-7" title="7">}</a></code></pre></div>
<p>When you request a matching URL, for example,</p>
<pre><code>https://example.com/wapp/hello.tcl</code></pre>
<p>the Caddy server will deliver a text page similar to the following. The CGI application (in this case, wapptclsh) will not be called.</p>
<pre><code>CGI for Caddy inspection page

Executable .................... /usr/local/bin/wapptclsh
  Arg 1 ....................... /home/quixote/projects/wapp/hello.tcl
Root .......................... /
Dir ........................... /home/quixote/www
Environment
  DB .......................... /usr/local/share/app/app.db
  PATH_INFO ...................
  REMOTE_USER .................
  SCRIPT_EXEC ................. /usr/local/bin/wapptclsh /home/quixote/projects/wapp/hello.tcl
  SCRIPT_FILENAME ............. /usr/local/bin/wapptclsh
  SCRIPT_NAME ................. /wapp/hello
  SECRET ...................... /usr/local/share/app/secret
Inherited environment
  HOME ........................ /home/quixote
  LANG ........................ en_US.UTF-8
Placeholders
  {.} ......................... /home/quixote/go/src/github.com/mholt/caddy/caddy
  {host} ...................... example.com
  {match} ..................... /wapp/hello
  {method} .................... GET
  {root} ...................... /home/quixote/www
  {when} ...................... 23/May/2018:14:49:55 -0400</code></pre>
<p>This information can be used to diagnose problems with how a CGI application is called.</p>
<p>To return to operation mode, remove or comment out the <code>inspect</code> subdirective.</p>
<h3 id="environment-variable-example">Environment Variable Example</h3>
<p>In this example, the Caddyfile looks like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb14-1" title="1"><span class="dv">192</span>.<span class="dv">168</span>.<span class="fl">1.2</span>:<span class="dv">8080</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">root</span> /usr/local/www</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw">cgi</span> /show /usr/local/<span class="kw">cgi</span>-bin/report/gen</a></code></pre></div>
<p>Note that a request for /show gets mapped to a script named /usr/local/cgi-bin/report/gen. There is no need for any element of the script name to match any element of the match pattern.</p>
<p>The contents of /usr/local/cgi-bin/report/gen are:</p>
<pre class="shell"><code>#!/bin/bash

printf &quot;Content-type: text/plain\n\n&quot;

printf &quot;example error message\n&quot; &gt; /dev/stderr

if [ &quot;POST&quot; = &quot;$REQUEST_METHOD&quot; -a -n &quot;$CONTENT_LENGTH&quot; ]; then
  read -n &quot;$CONTENT_LENGTH&quot; POST_DATA
fi

printf &quot;AUTH_TYPE         [%s]\n&quot; $AUTH_TYPE
printf &quot;CONTENT_LENGTH    [%s]\n&quot; $CONTENT_LENGTH
printf &quot;CONTENT_TYPE      [%s]\n&quot; $CONTENT_TYPE
printf &quot;GATEWAY_INTERFACE [%s]\n&quot; $GATEWAY_INTERFACE
printf &quot;PATH_INFO         [%s]\n&quot; $PATH_INFO
printf &quot;PATH_TRANSLATED   [%s]\n&quot; $PATH_TRANSLATED
printf &quot;POST_DATA         [%s]\n&quot; $POST_DATA
printf &quot;QUERY_STRING      [%s]\n&quot; $QUERY_STRING
printf &quot;REMOTE_ADDR       [%s]\n&quot; $REMOTE_ADDR
printf &quot;REMOTE_HOST       [%s]\n&quot; $REMOTE_HOST
printf &quot;REMOTE_IDENT      [%s]\n&quot; $REMOTE_IDENT
printf &quot;REMOTE_USER       [%s]\n&quot; $REMOTE_USER
printf &quot;REQUEST_METHOD    [%s]\n&quot; $REQUEST_METHOD
printf &quot;SCRIPT_EXEC       [%s]\n&quot; $SCRIPT_EXEC
printf &quot;SCRIPT_NAME       [%s]\n&quot; $SCRIPT_NAME
printf &quot;SERVER_NAME       [%s]\n&quot; $SERVER_NAME
printf &quot;SERVER_PORT       [%s]\n&quot; $SERVER_PORT
printf &quot;SERVER_PROTOCOL   [%s]\n&quot; $SERVER_PROTOCOL
printf &quot;SERVER_SOFTWARE   [%s]\n&quot; $SERVER_SOFTWARE

exit 0</code></pre>
<p>The purpose of this script is to show how request information gets communicated to a CGI script. Note that POST data must be read from standard input. In this particular case, posted data gets stored in the variable <code>POST_DATA</code>. Your script may use a different method to read POST content. Secondly, the <code>SCRIPT_EXEC</code> variable is not a CGI standard. It is provided by this middleware and contains the entire command line, including all arguments, with which the CGI script was executed.</p>
<p>When a browser requests</p>
<pre><code>http://192.168.1.2:8080/show/weekly?mode=summary</code></pre>
<p>the response looks like</p>
<pre><code>AUTH_TYPE         []
CONTENT_LENGTH    []
CONTENT_TYPE      []
GATEWAY_INTERFACE [CGI/1.1]
PATH_INFO         [/weekly]
PATH_TRANSLATED   []
POST_DATA         []
QUERY_STRING      [mode=summary]
REMOTE_ADDR       [192.168.1.35]
REMOTE_HOST       [192.168.1.35]
REMOTE_IDENT      []
REMOTE_USER       []
REQUEST_METHOD    [GET]
SCRIPT_EXEC       [/usr/local/cgi-bin/report/gen]
SCRIPT_NAME       [/show]
SERVER_NAME       [192.168.1.2:8080]
SERVER_PORT       [8080]
SERVER_PROTOCOL   [HTTP/1.1]
SERVER_SOFTWARE   [go]</code></pre>
<p>When a client makes a POST request, such as with the following command</p>
<pre class="shell"><code>wget -O - -q --post-data=&quot;city=San%20Francisco&quot; http://192.168.1.2:8080/show/weekly?mode=summary</code></pre>
<p>the response looks the same except for the following lines:</p>
<pre><code>CONTENT_LENGTH    [20]
CONTENT_TYPE      [application/x-www-form-urlencoded]
POST_DATA         [city=San%20Francisco]
REQUEST_METHOD    [POST]</code></pre>
<h3 id="fossil-example">Fossil Example</h3>
<p>The <a href="https://www.fossil-scm.org/">fossil</a> distributed software management tool is a native executable that supports interaction as a CGI application. In this example, /usr/bin/fossil is the executable and /home/quixote/projects.fossil is the fossil repository. To configure Caddy to serve it, use a cgi directive something like this in your Caddyfile:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">cgi</span> /projects /usr/bin/fossil /usr/local/<span class="kw">cgi</span>-bin/projects</a></code></pre></div>
<p>In your /usr/local/cgi-bin directory, make a file named projects with the following single line:</p>
<pre><code>repository: /home/quixote/projects.fossil</code></pre>
<p>The fossil documentation calls this a command file. When fossil is invoked after a request to /projects, it examines the relevant environment variables and responds as a CGI application. If you protect /projects with <a href="https://caddyserver.com/docs/basicauth">basic HTTP authentication</a>, you may wish to enable the <strong>Allow REMOTE_USER authentication</strong> option when setting up fossil. This lets fossil dispense with its own authentication, assuming it has an account for the user.</p>
<h3 id="agedu-example">Agedu Example</h3>
<p>The <a href="http://www.chiark.greenend.org.uk/~sgtatham/agedu/">agedu</a> utility can be used to identify unused files that are taking up space on your storage media. Like fossil, it can be used in different modes including CGI. First, use it from the command line to generate an index of a directory, for example</p>
<pre><code>agedu --file /home/quixote/agedu.dat --scan /home/quixote</code></pre>
<p>In your Caddyfile, include a directive that references the generated index:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">cgi</span> /agedu /usr/local/bin/agedu --<span class="kw">cgi</span> --file /home/quixote/agedu.dat</a></code></pre></div>
<p>You will want to protect the /agedu resource with some sort of access control, for example <a href="https://caddyserver.com/docs/basicauth">HTTP Basic Authentication</a>.</p>
<h3 id="go-source-example">Go Source Example</h3>
<p>This small example demonstrates how to write a CGI program in Go. The use of a bytes.Buffer makes it easy to report the content length in the CGI header.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode go"><code class="sourceCode go"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">package</span> main</a>
<a class="sourceLine" id="cb24-2" title="2"></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw">import</span> (</a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="st">&quot;bytes&quot;</span></a>
<a class="sourceLine" id="cb24-5" title="5">    <span class="st">&quot;fmt&quot;</span></a>
<a class="sourceLine" id="cb24-6" title="6">    <span class="st">&quot;os&quot;</span></a>
<a class="sourceLine" id="cb24-7" title="7">    <span class="st">&quot;time&quot;</span></a>
<a class="sourceLine" id="cb24-8" title="8">)</a>
<a class="sourceLine" id="cb24-9" title="9"></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="kw">func</span> main() {</a>
<a class="sourceLine" id="cb24-11" title="11">    <span class="kw">var</span> buf bytes.Buffer</a>
<a class="sourceLine" id="cb24-12" title="12"></a>
<a class="sourceLine" id="cb24-13" title="13">    fmt.Fprintf(&amp;buf, <span class="st">&quot;Server time at %s is %s</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb24-14" title="14">        os.Getenv(<span class="st">&quot;SERVER_NAME&quot;</span>), time.Now().Format(time.RFC1123))</a>
<a class="sourceLine" id="cb24-15" title="15">    fmt.Println(<span class="st">&quot;Content-type: text/plain&quot;</span>)</a>
<a class="sourceLine" id="cb24-16" title="16">    fmt.Printf(<span class="st">&quot;Content-Length: %d</span><span class="ch">\n\n</span><span class="st">&quot;</span>, buf.Len())</a>
<a class="sourceLine" id="cb24-17" title="17">    buf.WriteTo(os.Stdout)</a>
<a class="sourceLine" id="cb24-18" title="18">}</a></code></pre></div>
<p>When this program is compiled and installed as /usr/local/bin/servertime, the following directive in your Caddy file will make it available:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">cgi</span> /servertime /usr/local/bin/servertime</a></code></pre></div>
<h3 id="cgit-example">Cgit Example</h3>
<p>The <a href="https://git.zx2c4.com/cgit/about/">cgit</a> application provides an attractive and useful web interface to git repositories. Here is how to run it with Caddy. After compiling cgit, you can place the executable somewhere out of Caddy’s document root. In this example, it is located in /usr/local/cgi-bin.</p>
<p>A sample configuration file is included in the project’s cgitrc.5.txt file. You can use it as a starting point for your configuration. The default location for this file is /etc/cgitrc but in this example the location /home/quixote/caddy/cgitrc. Note that changing the location of this file from its default will necessitate the inclusion of the environment variable CGIT_CONFIG in the Caddyfile cgi directive.</p>
<p>When you edit the repository stanzas in this file, be sure each repo.path item refers to the .git directory within a working checkout. Here is an example stanza:</p>
<pre><code>repo.url=caddy-cgi
repo.path=/home/quixote/go/src/github.com/jung-kurt/caddy-cgi/.git
repo.desc=CGI for Caddy
repo.owner=jung-kurt
repo.readme=/home/quixote/go/src/github.com/jung-kurt/caddy-cgi/README.md</code></pre>
<p>Also, you will likely want to change cgit’s cache directory from its default in /var/cache (generally accessible only to root) to a location writeable by Caddy. In this example, cgitrc contains the line</p>
<pre><code>cache-root=/home/quixote/.cache/cgit</code></pre>
<p>You may need to create the cgit subdirectory.</p>
<p>There are some static cgit resources (namely, cgit.css, favicon.ico, and cgit.png) that will be accessed from Caddy’s document tree. For this example, these files are placed in a directory named cgit-resource. The following lines are part of the cgitrc file:</p>
<pre><code>css=/cgit-resource/cgit.css
favicon=/cgit-resource/favicon.ico
logo=/cgit-resource/cgit.png</code></pre>
<p>Additionally, you will likely need to tweak the various file viewer filters such source-filter and about-filter based on your system.</p>
<p>The following Caddyfile directive will allow you to access the cgit application at /cgit:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">cgi</span> {</a>
<a class="sourceLine" id="cb29-2" title="2">    <span class="kw">match</span> /cgit</a>
<a class="sourceLine" id="cb29-3" title="3">    <span class="kw">exec</span> /usr/local/<span class="kw">cgi</span>-bin/cgit</a>
<a class="sourceLine" id="cb29-4" title="4">    <span class="kw">env</span> CGIT_CONFIG=/home/quixote/caddy/cgitrc</a>
<a class="sourceLine" id="cb29-5" title="5">}</a></code></pre></div>
<h3 id="php-example">PHP Example</h3>
<p>Feeling reckless? You can run <a href="http://php.net/">PHP</a> in CGI mode. In general, <a href="https://caddyserver.com/docs/fastcgi">FastCGI</a> is the preferred method to run PHP if your application has many pages or a fair amount of database activity. But for small PHP programs that are seldom used, CGI can work fine. You’ll need the php-cgi interpreter for your platform. This may involve downloading the executable or downloading and then compiling the source code. For this example, assume the interpreter is installed as /usr/local/bin/php-cgi. Additionally, because of the way PHP operates in CGI mode, you will need an intermediate script. This one works in Posix environments:</p>
<pre class="shell"><code>#!/bin/bash

REDIRECT_STATUS=1 SCRIPT_FILENAME=&quot;${1}&quot; /usr/local/bin/php-cgi -c /home/quixote/.config/php/php-cgi.ini</code></pre>
<p>This script can be reused for multiple cgi directives. In this example, it is installed as /usr/local/cgi-bin/phpwrap. The argument following -c is your initialization file for PHP. In this example, it is named /home/quixote/.config/php/php-cgi.ini.</p>
<p>Two PHP files will be used for this example. The first, /usr/local/cgi-bin/sample/min.php, looks like this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb31-1" title="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="kw">&lt;html&gt;</span></a>
<a class="sourceLine" id="cb31-3" title="3">  <span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb31-4" title="4">    <span class="kw">&lt;title&gt;</span>PHP Sample<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb31-5" title="5">    <span class="kw">&lt;style&gt;</span></a>
<a class="sourceLine" id="cb31-6" title="6">      form span {</a>
<a class="sourceLine" id="cb31-7" title="7">        <span class="kw">font</span>: <span class="dv">15</span><span class="dt">px</span> <span class="dv">sans-serif</span><span class="op">;</span></a>
<a class="sourceLine" id="cb31-8" title="8">        <span class="kw">display</span>: <span class="dv">inline-block</span><span class="op">;</span></a>
<a class="sourceLine" id="cb31-9" title="9">        <span class="kw">width</span>: <span class="dv">8</span><span class="dt">em</span><span class="op">;</span></a>
<a class="sourceLine" id="cb31-10" title="10">        <span class="kw">text-align</span>: <span class="dv">right</span><span class="op">;</span></a>
<a class="sourceLine" id="cb31-11" title="11">      }</a>
<a class="sourceLine" id="cb31-12" title="12">    <span class="kw">&lt;/style&gt;</span></a>
<a class="sourceLine" id="cb31-13" title="13">  <span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb31-14" title="14">  <span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb31-15" title="15">    <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;action.php&quot;</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb31-16" title="16">      <span class="kw">&lt;p&gt;&lt;span&gt;</span>Name<span class="kw">&lt;/span&gt;</span> <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span> <span class="kw">/&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb31-17" title="17">      <span class="kw">&lt;p&gt;&lt;span&gt;</span>Number<span class="kw">&lt;/span&gt;</span> <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;number&quot;</span> <span class="kw">/&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb31-18" title="18">      <span class="kw">&lt;p&gt;&lt;span&gt;</span>Day<span class="kw">&lt;/span&gt;</span> <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;day&quot;</span></a>
<a class="sourceLine" id="cb31-19" title="19"><span class="ot">        value=</span><span class="st">&quot;</span><span class="er">&lt;</span><span class="st">?php echo(date(&quot;</span><span class="er">l&quot;,</span><span class="ot"> time</span><span class="er">()));</span> <span class="er">?</span><span class="kw">&gt;</span>&quot; /&gt;<span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb31-20" title="20">      <span class="kw">&lt;p&gt;&lt;span&gt;</span><span class="dv">&amp;nbsp;</span><span class="kw">&lt;/span&gt;</span> <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span> <span class="kw">/&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb31-21" title="21">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb31-22" title="22">  <span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb31-23" title="23"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>The second, /usr/local/cgi-bin/sample/action.php, follows:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb32-1" title="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="kw">&lt;html&gt;</span></a>
<a class="sourceLine" id="cb32-3" title="3">  <span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb32-4" title="4">    <span class="kw">&lt;title&gt;</span>PHP Sample<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb32-5" title="5">  <span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb32-6" title="6">  <span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb32-7" title="7">    <span class="kw">&lt;p&gt;</span>Name is <span class="kw">&lt;strong&gt;&lt;?php</span> echo htmlspecialchars($_POST[&#39;name&#39;]); <span class="kw">?&gt;&lt;/strong&gt;</span>.<span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb32-8" title="8">    <span class="kw">&lt;p&gt;</span>Number is <span class="kw">&lt;strong&gt;&lt;?php</span> echo (int)$_POST[&#39;number&#39;]; <span class="kw">?&gt;&lt;/strong&gt;</span>.<span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb32-9" title="9">    <span class="kw">&lt;p&gt;</span>Day is <span class="kw">&lt;strong&gt;&lt;?php</span> echo htmlspecialchars($_POST[&#39;day&#39;]); <span class="kw">?&gt;&lt;/strong&gt;</span>.<span class="kw">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb32-10" title="10">  <span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb32-11" title="11"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>The following directive in your Caddyfile will make the application available at sample/min.php:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode caddy"><code class="sourceCode caddy"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">cgi</span> /sample/*.php /usr/local/<span class="kw">cgi</span>-bin/phpwrap /usr/local/<span class="kw">cgi</span>-bin{<span class="kw">match</span>}</a></code></pre></div>
</body>

</html>
